{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "Creates all of the Elastic Beanstalk resouces to deploy ${environment.name}",
	"Parameters": {
		"AwsKey": {
			"Description": "Depricated. Will be removed",
			"Type": "String",
			"NoEcho": true
		},
		"AwsSecret": {
			"Description": "Depricated. Will be removed",
			"Type": "String",
			"NoEcho": true
		},
		"EncryptionKey": {
			"Description": "Depricated. Will be removed",
			"Type": "String",
			"NoEcho": true
		}
	},
	"Resources": {
		"${environment.refName}Version": {
			"Type": "AWS::ElasticBeanstalk::ApplicationVersion",
			"Properties": {
				"ApplicationName": {
					"Fn::ImportValue": "${sharedExportPrefix}-Beanstalk-Application-Name"
				},
				"Description": "Artifact for ${environment.name}",
				"SourceBundle": {
					"S3Bucket": "${environment.sourceBundle.bucket}",
					"S3Key": "${environment.sourceBundle.key}"
				}
			}
		},
		"${environment.refName}Tempalte": {
			"Type": "AWS::ElasticBeanstalk::ConfigurationTemplate",
			"Properties": {
				"ApplicationName": {
					"Fn::ImportValue": "${sharedExportPrefix}-Beanstalk-Application-Name"
				},
				"Description": "ConfigurationTemplate for ${environment.name}",
				"SolutionStackName": "64bit Amazon Linux 2018.03 v2.8.0 running Tomcat 8 Java 8",
				"OptionSettings": [
					{
						"Namespace": "aws:autoscaling:asg",
						"OptionName": "Cooldown",
						"Value": "360"
					},
					{
						"Namespace": "aws:autoscaling:asg",
						"OptionName": "MinSize",
						"Value": "${environment.minInstances}"
					},
					{
						"Namespace": "aws:autoscaling:asg",
						"OptionName": "MaxSize",
						"Value": "${environment.maxInstances}"
					},
					{
						"Namespace": "aws:autoscaling:asg",
						"OptionName": "Availability Zones",
						"Value": "Any 2"
					},
					{
						"Namespace": "aws:autoscaling:launchconfiguration",
						"OptionName": "EC2KeyName",
						"Value": "${stack}-key-pair"
					},
					{
						"Namespace": "aws:autoscaling:launchconfiguration",
						"OptionName": "IamInstanceProfile",
						"Value": "${stack}-s3-log-rolling"
					},
					{
						"Namespace": "aws:autoscaling:launchconfiguration",
						"OptionName": "InstanceType",
						"Value": "m1.small"
					},
					{
						"Namespace": "aws:autoscaling:launchconfiguration",
						"OptionName": "MonitoringInterval",
						"Value": "1 minute"
					},
					{
						"Namespace": "aws:autoscaling:launchconfiguration",
						"OptionName": "SecurityGroups",
						"Value": {
							"Fn::ImportValue": "${sharedExportPrefix}-Beanstalk-Security-Group-ID"
						}
					},
					{
						"Namespace": "aws:autoscaling:launchconfiguration",
						"OptionName": "SSHSourceRestriction",
						"Value": {
							"Fn::Join": [
								",",
								[
									"tcp,22,22",
									{
										"Fn::ImportValue": "${vpcExportPrefix}-VpnCidr"
									}
								]
							]
						}
					},
					{
						"Namespace": "aws:autoscaling:trigger",
						"OptionName": "BreachDuration",
						"Value": "10"
					},
					{
						"Namespace": "aws:autoscaling:trigger",
						"OptionName": "LowerBreachScaleIncrement",
						"Value": "-1"
					},
					{
						"Namespace": "aws:autoscaling:trigger",
						"OptionName": "LowerThreshold",
						"Value": "60"
					},
					{
						"Namespace": "aws:autoscaling:trigger",
						"OptionName": "MeasureName",
						"Value": "CPUUtilization"
					},
					{
						"Namespace": "aws:autoscaling:trigger",
						"OptionName": "Period",
						"Value": "10"
					},
					{
						"Namespace": "aws:autoscaling:trigger",
						"OptionName": "Statistic",
						"Value": "Average"
					},
					{
						"Namespace": "aws:autoscaling:trigger",
						"OptionName": "Unit",
						"Value": "Percent"
					},
					{
						"Namespace": "aws:autoscaling:trigger",
						"OptionName": "UpperBreachScaleIncrement",
						"Value": "1"
					},
					{
						"Namespace": "aws:autoscaling:trigger",
						"OptionName": "UpperThreshold",
						"Value": "90"
					},
					{
						"Namespace": "aws:ec2:vpc",
						"OptionName": "VPCId",
						"Value": {
							"Fn::ImportValue": "${vpcExportPrefix}-VPCId"
						}
					},
					{
						"Namespace": "aws:ec2:vpc",
						"OptionName": "Subnets",
						"Value": {
							"Fn::ImportValue": "${vpcExportPrefix}-${subnetGroupColor}-Private-Subnets"
						}
					},
					{
						"Namespace": "aws:ec2:vpc",
						"OptionName": "ELBSubnets",
						"Value": {
							"Fn::ImportValue": "${vpcExportPrefix}-Public-Subnets"
						}
					},
					{
						"Namespace": "aws:ec2:vpc",
						"OptionName": "AssociatePublicIpAddress",
						"Value": "false"
					},
					{
						"Namespace": "aws:elasticbeanstalk:environment",
						"OptionName": "EnvironmentType",
						"Value": "LoadBalanced"
					},
					{
						"Namespace": "aws:elasticbeanstalk:environment",
						"OptionName": "LoadBalancerType",
						"Value": "classic"
					},
					{
						"Namespace": "aws:elasticbeanstalk:application",
						"OptionName": "Application Healthcheck URL",
						"Value": "${environment.healthCheckUrl}"
					},
					{
						"Namespace": "aws:elasticbeanstalk:sns:topics",
						"OptionName": "Notification-Endpoint",
						"Value": {
							"Fn::ImportValue": "${sharedExportPrefix}-DB-SNS-Topic-ID"
						}
					},
					{
						"Namespace": "aws:elb:healthcheck",
						"OptionName": "HealthyThreshold",
						"Value": "3"
					},
					{
						"Namespace": "aws:elb:healthcheck",
						"OptionName": "Interval",
						"Value": "30"
					},
					{
						"Namespace": "aws:elb:healthcheck",
						"OptionName": "Timeout",
						"Value": "5"
					},
					{
						"Namespace": "aws:elb:healthcheck",
						"OptionName": "UnhealthyThreshold",
						"Value": "5"
					},
					{
						"Namespace": "aws:elb:loadbalancer",
						"OptionName": "CrossZone",
						"Value": "false"
					},
					{
						"Namespace": "aws:elb:loadbalancer",
						"OptionName": "SecurityGroups",
						"Value": {
							"Fn::ImportValue": "${sharedExportPrefix}-Load-Balancer-Security-Group-ID"
						}
					},
					{
						"Namespace": "aws:elb:listener:443",
						"OptionName": "ListenerProtocol",
						"Value": "HTTPS"
					},
					{
						"Namespace": "aws:elb:listener:443",
						"OptionName": "InstancePort",
						"Value": "80"
					},
					{
						"Namespace": "aws:elb:listener:443",
						"OptionName": "InstanceProtocol",
						"Value": "HTTP"
					},
					{
						"Namespace": "aws:elb:listener:443",
						"OptionName": "SSLCertificateId",
						"Value": "${environment.sslCertificateARN}"
					},
					{
						"Namespace": "aws:elb:listener:443",
						"OptionName": "ListenerEnabled",
						"Value": "true"
					},
					{
						"Namespace": "aws:elasticbeanstalk:container:tomcat:jvmoptions",
						"OptionName": "Xms",
						"Value": "256m"
					},
					{
						"Namespace": "aws:elasticbeanstalk:container:tomcat:jvmoptions",
						"OptionName": "Xmx",
						"Value": "1024m"
					},
					{
						"Namespace": "aws:elasticbeanstalk:application:environment",
						"OptionName": "AWS_ACCESS_KEY_ID",
						"Value": {
							"Ref": "AwsKey"
						}
					},
					{
						"Namespace": "aws:elasticbeanstalk:application:environment",
						"OptionName": "AWS_SECRET_KEY",
						"Value": {
							"Ref": "AwsSecret"
						}
					},
					{
						"Namespace": "aws:elasticbeanstalk:application:environment",
						"OptionName": "PARAM1",
						"Value": "${configurationUrl}"
					},
					{
						"Namespace": "aws:elasticbeanstalk:application:environment",
						"OptionName": "PARAM2",
						"Value": {
							"Ref": "EncryptionKey"
						}
					},
					{
						"Namespace": "aws:elasticbeanstalk:application:environment",
						"OptionName": "PARAM3",
						"Value": "${stack}"
					},
					{
						"Namespace": "aws:elasticbeanstalk:application:environment",
						"OptionName": "PARAM4",
						"Value": "${instance}"
					}
				]
			}
		},
		"${environment.refName}": {
			"Type": "AWS::ElasticBeanstalk::Environment",
			"Properties": {
				"ApplicationName": {
					"Fn::ImportValue": "${sharedExportPrefix}-Beanstalk-Application-Name"
				},
				"CNAMEPrefix": "${environment.cnamePrefix}",
				"Description": "Environment for ${environment.name}",
				"EnvironmentName": "${environment.name}",
				"TemplateName": {
					"Ref": "${environment.refName}Tempalte"
				},
				"VersionLabel": {
					"Ref": "${environment.refName}Version"
				}
			}
		},
		"${environment.refName}CNAME": {
			"Type": "AWS::Route53::RecordSet",
			"Properties": {
				"HostedZoneName": "${environment.hostedZone}.",
				"Name": "${environment.name}.${environment.hostedZone}.",
				"ResourceRecords": [
					"${environment.cnamePrefix}.us-east-1.elasticbeanstalk.com"
				],
				"TTL": "300",
				"Type": "CNAME"
			}
		}
	}
}
