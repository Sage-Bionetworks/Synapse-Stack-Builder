{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "...",
	"Resources": {
		"${stack}${instance}AgentRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": "bedrock.amazonaws.com"
							},
							"Action": "sts:AssumeRole",
							"Condition": {
								"StringEquals": {
									"aws:SourceAccount": {
										"Ref": "AWS::Region"
									}
								},
								"ArnLike": {
									"aws:SourceArn": {
										"Fn::Sub": "arn:aws:bedrock:#[[${AWS::Region}]]#:#[[${AWS::AccountId}]]#:agent/*"
									}
								}
							}
						}
					]
				},
				"Policies": [
					{
						"PolicyName": "allowBedrockToInvokeAnyModel",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Effect": "Allow",
									"Action": "bedrock:InvokeModel",
									"Resource": [
										"arn:aws:bedrock:us-east-1::foundation-model/*"
									]
								}
							]
						}
					}
				]
			}
		},
		"baseLambdaLayer": {
			"Type": "AWS::Lambda::LayerVersion",
			"Properties": {
				"CompatibleRuntimes": [
					"java17"
				],
				"Content": {
					"S3Bucket": "${bucketName}",
					"S3Key": "${layerZipKey}"
				},
				"Description": "This layer contains all of the dependnecies for the agent function lambda.",
				"LayerName": "${layerName}",
				"LicenseInfo": "MIT"
			}
		},
		"${actionGroupFunctionName}": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Code": {
					"S3Bucket": "${bucketName}",
					"S3Key": "${lambdaJarKey}"
				},
				"Description": "This jar file contains the lambda function (without-dependencies} used for agent functions",
				"MemorySize": 512,
				"Timeout": 15,
				"Handler": "org.sagebionetworks.agent.action.MainRequestHandler::handleRequest",
				"Layers": [
					{
						"Ref": "baseLambdaLayer"
					}
				],
				"Runtime": "java17",
				"Architectures": [
					"x86_64"
				],
				"EphemeralStorage": {
					"Size": 512
				},
				"PackageType": "Zip",
				"Policies": [
					{
						"Statement": [
							{
								"Effect": "Allow",
								"Action": [
									"logs:CreateLogGroup"
								],
								"Resource": {
									"Fn::Sub": "arn:aws:logs:us-east-1:#[[${AWS::AccountId}]]#:*"
								}
							},
							{
								"Effect": "Allow",
								"Action": [
									"logs:CreateLogStream",
									"logs:PutLogEvents"
								],
								"Resource": [
									{
										"Fn::Sub": "arn:aws:logs:us-east-1:#[[${AWS::AccountId}]]#:log-group:/aws/lambda/${actionGroupFunctionName}:*"
									}
								]
							}
						]
					}
				],
				"SnapStart": {
					"ApplyOn": "None"
				},
				"RuntimeManagementConfig": {
					"UpdateRuntimeOn": "Auto"
				}
			}
		}
	}
}
