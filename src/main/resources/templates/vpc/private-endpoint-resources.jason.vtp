{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "Creates a VPC Endpoint for all private-subnets.",
	"Resources": {
 	   "VPCEndpoint": {
    		"Type": "AWS::EC2::VPCEndpoint",
    		"Properties": {
    			"PolicyDocument": {
    				"Version": "2012-10-17",
    				"Statement": [{
    					"Effect": "Allow",
    					"Principal": "*",
    					"Action": ["*"],
           			"Resource": ["*"]
        			}]
     			},
     			"RouteTableIds": { "Fn::Join": [
     								", ",
     								[
     								    #set($subnetGroups=$subnets.privateSubnetGroups)
     									#set($i = 0)
     									#foreach( $group in $subnetGroups )
     									#if( $i > 0 ) , #end
     									{"Fn::ImportValue": { "Fn::Join": ["-",[{"Ref": "AWS::Region"},"${vpcStackName}","private-subnets","$group.color","Private-Subnets-RouteTableIds"]] }}
     									#set($i = $i+1)
     									#end
     								]
                ]},
     			"ServiceName": {"Fn::Join": ["", [ "com.amazonaws.",{ "Ref": "AWS::Region"},".s3"]]},
     			"VpcId": {
                  	"Fn::ImportValue": {
                      	"Fn::Join": [
                        	  "-",
                          	[
                              	{
                                  	"Ref": "AWS::Region"
                              	},
                              	"${vpcStackName}",
                              	"VPCId"
                          	]
                      	]
                  	}
              	}
			}
		}
	}
}
    
